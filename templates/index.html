{% extends "root.html" %}

{% block title %}Home{% endblock %}

{% block content %}

  <div class="row">
    <div class="col-sm-6">
      <div class="card">
        <div class="card-header">
          <label class="mb-0" for="int_display">Numeric</label>
        </div>
        <div class="card-body">
          <!-- integer display -->
          <textarea id="int_display" class="form-control bg-dark text-white border-white" disabled
                    rows="10"></textarea>
        </div>
      </div>
    </div>
    <div class="col-sm-6 mt-4 mt-sm-0">
      <div class="card">
        <div class="card-header">
          <label class="mb-0" for="bool_display">Boolean</label>
        </div>
        <div class="card-body">
          <!-- boolean display -->
          <textarea id="bool_display" class="form-control bg-dark text-white border-white" disabled
                    rows="10"></textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header">
      <ul class="nav nav-pills card-header-pills" id="logNavBar">
      </ul>
    </div>
    <div class="card-body mt-0">
      <!-- console display -->
      <textarea id="out_display" class="form-control bg-dark text-white border-white" disabled
                rows="15"></textarea>

      <!-- console toolbar -->
      <div class="btn-toolbar" role="toolbar">
        <!-- auto scroll button -->
        <div class="col-auto ml-auto px-0">
          <button id="in_autoScroll" type="button" data-toggle="button" class="btn btn-outline-primary active">
            Auto Scroll
          </button>
        </div>
      </div>

    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    // select page objects
    const $outDisplay = $('#out_display');
    const $inAutoScroll = $('#in_autoScroll');
    const $boolDisplay = $('#bool_display');
    const $intDisplay = $('#int_display');
    const $heart = $('#heart');
    var logStreams = {'currentStream':''};
    var ackId = 0;
    var watchDogTimer = 0;

    // connect to stream
    const xhr = new XMLHttpRequest();
    xhr.open('GET', "{{ url_for('console_stream') }}");
    xhr.send();
    let position = 0;

    function selectStream(newStream) {
      let currentStream = getCurrentStream();
      // No change
      if (currentStream == newStream) return;

      if (currentStream != '')
        document.getElementById(currentStream).classList.remove("active");

      document.getElementById(newStream).classList.add("active");
      setCurrentStream(newStream);
      updateOutDisplay(newStream);
    }

    function updateOutDisplay(steamName) {
      $outDisplay.val(logStreams[steamName]);

      if ($inAutoScroll.hasClass('active'))
        $outDisplay.scrollTop($outDisplay[0].scrollHeight);
    }

    function connectionAlive(deltaMilliseconds = 1000) {
      let currentTime = (new Date()).getTime();
      return currentTime - watchDogTimer < deltaMilliseconds;
    }

    // update display, with delay
    function update() {
      let messages = xhr.responseText.split('\n');
      messages.slice(position, -1).forEach(function (messageString) {

        // interpret the JSON object string
        const messageJson = JSON.parse(messageString);

        if (messageJson.hasOwnProperty("ack") && ackId == messageJson["ack"]) {
          // No new data, may be dead
          if (!connectionAlive()) {
            heart.classList.remove("alive");
          }
          // Still live, but no updates
          return;
        }
        // New message, refresh heartbeat
        else if (messageJson.hasOwnProperty("ack")) {
          ackId = messageJson["ack"];
          watchDogTimer = (new Date()).getTime();
        }
        
        heart.classList.add("alive");

        // clear the displays
        $intDisplay.val('');
        $boolDisplay.val('');

        // interperate the sensors
        interpretData(messageJson);
      });
      position = messages.length - 1;
    }

    function interpretData(messageJson) {
      for (const key in messageJson) {
        // Skip ack
        if (key == "ack") continue;

        const data = messageJson[key];
        const dataType = typeof(data);

        switch (dataType) {
          case "boolean":
            $boolDisplay.val($boolDisplay.val() + key + ": " + data + "\n");
            continue;

          case "number":
            $intDisplay.val($intDisplay.val() + key + ": " + data + "\n");
            continue;
            
          case "string":
            // Modify approperiate stream
            interpretLogData(key, data);
            // Reflow stream in case it was changed
            updateOutDisplay(getCurrentStream());
            continue;
        }
        // Higher order objects
        if (data.hasOwnProperty("units")) {
          $intDisplay.val($intDisplay.val() + key + ": " + data["data"] + " " + data["units"] + "\n");
          continue;
        }

        // Final default, unknown object format
        let dataString = "";
        for (const property in data) {
          dataString += property + ": " + data[property] + ", ";
        }
        // Modify approperiate stream
        interpretLogData(key, dataString);
        // Reflow stream in case it was changed
        updateOutDisplay(getCurrentStream());
      }
    }

    function interpretLogData(logName, data, limit = 2048) {
      // Does not have key or nav pill yet
      if (!logStreams.hasOwnProperty(logName)) {
        logStreams[logName] = "";

        const newNavPill = 
        `<li class="nav-item">
          <p class="nav-link mb-0" id="` + logName + `" onclick="selectStream(this.innerText)">` + logName + `</p>
        </li>`

        document.getElementById("logNavBar").innerHTML += newNavPill;
      }
      
      const dateObj = new Date();
      const time = "[" +dateObj.getMinutes()+ ":" +dateObj.getSeconds()+ "." +Math.floor(dateObj.getMilliseconds()/100)+ "]";
      // Concat old and new data
      const value = logStreams[logName] + time + ': ' + String(data) + '\n';
      // Store only the 'limit' number of characters
      logStreams[logName] = value.substring(value.length - limit);
    }

    function getCurrentStream() {
      return logStreams["currentStream"];
    }
    function setCurrentStream(streamName) {
      logStreams["currentStream"] = streamName;
    }

    setInterval(function () {
      // update the displays
      update();
    }, 150);
  </script>
{% endblock %}
